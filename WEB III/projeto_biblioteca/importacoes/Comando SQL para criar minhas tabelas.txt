-- Selecionando base de dados da biblioteca
USE biblioteca;

-- Criando tabela aluno
CREATE TABLE aluno(
    id INT AUTO_INCREMENT NOT NULL PRIMARY KEY,
    nome VARCHAR(50) NOT NULL,
    sobrenome VARCHAR(100) NOT NULL,
    telefone varchar(14) NOT NULL,
    email VARCHAR(80) NOT NULL,
    curso VARCHAR(50) NOT NULL,
    cpf VARCHAR(14) NOT NULL
)ENGINE=INNODB DEFAULT CHARSET=utf8mb4;

-- Criando tabela livro
CREATE TABLE livro(
    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    titulo VARCHAR(200) NOT NULL,
    editora VARCHAR(100) NOT NULL,
    ano_publicacao INT(4) NOT NULL,
    genero VARCHAR(50) NOT NULL,
    isbn VARCHAR(20) NOT NULL
)ENGINE=INNODB DEFAULT CHARSET=utf8mb4;  

-- Criando tabela autor
CREATE TABLE autor(
    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    nome VARCHAR(100)
)ENGINE=INNODB DEFAULT CHARSET=utf8mb4;  

-- Criando tabela livro_autor
CREATE TABLE livro_autor(
    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    id_livro INT NOT NULL,
    id_autor INT NOT NULL,
    CONSTRAINT fk_livro_autor_livro FOREIGN KEY (id_livro) REFERENCES livro(id) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_livro_autor_autor FOREIGN KEY (id_autor) REFERENCES autor(id) ON DELETE CASCADE ON UPDATE CASCADE
)ENGINE=INNODB DEFAULT CHARSET=utf8mb4;

-- Criando tabela exemplar (podem ter vários exemplares do mesmo livro)
CREATE TABLE exemplar(
    id INT AUTO_INCREMENT NOT NULL PRIMARY KEY,
    id_livro INT NOT NULL,
    CONSTRAINT fk_exemplar_livro FOREIGN KEY (id_livro) REFERENCES livro(id) ON DELETE CASCADE ON UPDATE CASCADE,
    numero_do_exemplar INT(11) NOT NULL, -- SERVE PARA PODER RASTREAR OS EXEMPLARES INDIVIDUALMENTE, JÁ QUE DEPENDENDO DA CÓPIA PODE ESTAR COM STATUS DIFERENTES
    status VARCHAR(20) NOT NULL -- Status possíveis: disponível, emprestado e reservado)
)ENGINE=INNODB DEFAULT CHARSET=utf8mb4;
    
-- Criando tabela de emprestimos

CREATE TABLE emprestimos(
    id INT AUTO_INCREMENT PRIMARY KEY NOT NULL,
    id_exemplar INT NOT NULL,
    id_aluno INT NOT NULL,
    data_emprestimo TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP(), -- Cria um atributo do tipo data com hora. Quando não informado, a data e hora atual são atribuidas.
    data_devolucao TIMESTAMP NOT NULL DEFAULT DATE_ADD(CURRENT_TIMESTAMP, INTERVAL 7 DAY), -- Setando a data de devolução como +7 dias a partir da data atual como default
    CONSTRAINT fk_emprestimos_exemplar FOREIGN KEY (id_exemplar) REFERENCES exemplar(id) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_emprestimos_aluno FOREIGN KEY (id_aluno) REFERENCES aluno(id) ON DELETE CASCADE ON UPDATE CASCADE    
)ENGINE=INNODB DEFAULT CHARSET=utf8mb4;

-- Criando a tabela de reserva

CREATE TABLE reserva(
    id INT AUTO_INCREMENT NOT NULL PRIMARY KEY,
    id_livro INT NOT NULL,
    id_aluno INT NOT NULL, 
    data_reserva TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_reserva_livro FOREIGN KEY (id_livro) REFERENCES livro(id) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_reserva_aluno FOREIGN KEY (id_aluno) REFERENCES aluno(id) ON DELETE CASCADE ON UPDATE CASCADE
    
)ENGINE=INNODB DEFAULT CHARSET=utf8mb4;    